worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # Backend upstream (Port 3001)
    upstream backend_api {
        server 127.0.0.1:3001;
    }

    server {
        listen       3000;
        server_name  localhost;

        root   html;
        index  index.html index.htm;

        # =========================================================
        # 1. EXCEPTION: ALLOW API ENDPOINTS
        # These locations match specific prefixes and bypass maintenance.
        # =========================================================
        
        location /api/v1 {
            proxy_pass http://backend_api;
            # We do NOT add the maintenance error page here, 
            # so these will only fail if the backend is actually dead.
        }

        location /api/v2 {
            proxy_pass http://backend_api;
        }

        # =========================================================
        # 2. RULE: BLOCK EVERYTHING ELSE (FORCE MAINTENANCE)
        # Any URL not matched above hits this block.
        # =========================================================
        
        location / {
            # Return 503 (Service Unavailable) immediately
            return 503;
        }

        # =========================================================
        # 3. MAINTENANCE PAGE HANDLER
        # This catches the 503 error from above and serves the file.
        # =========================================================

        # Catch the 503 error
        error_page 503 @show_maintenance;

        # Internal named location to rewrite to the file
        location @show_maintenance {
            rewrite ^(.*)$ /maintenance.html break;
        }

        # Crucial: Allow Nginx to actually read the maintenance file
        # (Otherwise this file itself would get blocked by the "/" rule)
        location = /maintenance.html {
            root html;
            internal;
        }
    }
}